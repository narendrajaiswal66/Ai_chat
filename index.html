<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Nexus AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f4;
            --fg-primary: #202124;
            --fg-secondary: #5f6368;
            --fg-muted: #80868b;
            --accent: #1a73e8;
            --accent-hover: #1557b0;
            --border: #dadce0;
            --card: #ffffff;
            --sidebar-bg: #f8f9fa;
            --user-bubble: #e8f0fe;
            --ai-bubble: #f1f3f4;
            --code-bg: #1e1e1e;
            --code-fg: #d4d4d4;
        }

        [data-theme="dark"] {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --fg-primary: #e6e6e6;
            --fg-secondary: #b4b4b4;
            --fg-muted: #808080;
            --accent: #4fc3f7;
            --accent-hover: #29b6f6;
            --border: #3c3c3c;
            --card: #252526;
            --sidebar-bg: #202020;
            --user-bubble: #1a3a52;
            --ai-bubble: #2d2d30;
            --code-bg: #0d0d0d;
            --code-fg: #d4d4d4;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            overflow-x: hidden;
        }

        body {
            min-height: 100vh;
            min-height: 100dvh;
        }

        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 9999;
            font-size: 1.125rem;
            color: var(--fg-secondary);
        }

        #loading.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.closed {
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar.closed {
                transform: translateX(0);
            }
        }

        .overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .chat-item {
            transition: all 0.15s ease;
            border-radius: 12px;
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
        }

        .message-bubble {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .message-bubble {
                animation: none;
            }
            .loading-spinner {
                animation: none;
            }
        }

        .message-bubble pre {
            background: var(--code-bg);
            color: var(--code-fg);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            margin: 12px 0;
        }

        .message-bubble code:not(pre code) {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
        }

        .message-bubble p {
            margin: 0 0 12px 0;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble ul, .message-bubble ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-bubble li {
            margin: 4px 0;
        }

        .input-container {
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            transition: all 0.2s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
        }

        [data-theme="dark"] .input-wrapper:focus-within {
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.15);
        }

        .chat-input {
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            color: var(--fg-primary);
            min-height: 24px;
            max-height: 200px;
        }

        .chat-input::placeholder {
            color: var(--fg-muted);
        }

        .send-btn {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .form-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            color: var(--fg-primary);
            width: 100%;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--fg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 24px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--fg-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--fg-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--fg-primary);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: var(--fg-muted);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent) 0%, #9c27b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pulse-ring {
            animation: pulseRing 2s ease-out infinite;
        }

        @keyframes pulseRing {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
        <span>Loading Nexus AI...</span>
    </div>

    <div id="app" style="display: none;">
        <!-- Mobile Overlay -->
        <div id="sidebarOverlay" class="overlay fixed inset-0 bg-black/50 z-30 md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar closed fixed md:relative z-40 w-72 h-screen flex flex-col">
            <div class="p-4 border-b border-[var(--border)]">
                <button id="newChatBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span class="font-medium">New Chat</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-3 scrollbar-thin">
                <div id="chatList" class="space-y-1"></div>
            </div>

            <div class="p-4 border-t border-[var(--border)]">
                <button id="toggleThemeBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-[var(--bg-tertiary)] transition-colors text-[var(--fg-secondary)]">
                    <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <span id="themeText" class="font-medium">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-h-screen min-h-[100dvh]">
            <!-- Header -->
            <header class="flex items-center gap-3 px-4 py-3 border-b border-[var(--border)] bg-[var(--bg-primary)]">
                <button id="menuBtn" class="icon-btn md:hidden">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 id="chatTitle" class="font-semibold text-lg truncate flex-1">New Chat</h1>
                <button id="editSystemBtn" class="icon-btn" title="Edit System Prompt">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                </button>
            </header>

            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto scrollbar-thin">
                <div id="emptyState" class="empty-state">
                    <div class="relative mb-6">
                        <div class="w-20 h-20 rounded-full bg-[var(--accent)] flex items-center justify-center">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2a10 10 0 1 0 10 10"></path>
                                <path d="M12 12l4-4"></path>
                                <path d="M12 2v4"></path>
                                <path d="M22 12h-4"></path>
                            </svg>
                        </div>
                        <div class="absolute inset-0 rounded-full border-2 border-[var(--accent)] pulse-ring"></div>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Welcome to <span class="gradient-text">Nexus AI</span></h2>
                    <p class="text-[var(--fg-secondary)] max-w-md">Your intelligent conversation partner. Ask anything, create content, or explore ideas together.</p>
                </div>
                <div id="messages" class="p-4 space-y-4"></div>
            </div>

            <!-- Input Area -->
            <div class="input-container p-4 pb-[max(1rem,env(safe-area-inset-bottom))]">
                <div class="max-w-3xl mx-auto">
                    <div class="input-wrapper flex items-end gap-2 p-2">
                        <textarea 
                            id="messageInput" 
                            class="chat-input flex-1 px-4 py-2" 
                            placeholder="Message Nexus AI..."
                            rows="1"
                        ></textarea>
                        <button id="sendBtn" class="send-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                    <p class="text-center text-xs text-[var(--fg-muted)] mt-2">Nexus AI can make mistakes. Verify important information.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- System Prompt Modal -->
    <div id="systemModal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="modal-content w-full max-w-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">System Prompt</h2>
                <button id="closeSystemBtn" class="icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--fg-secondary)]">Custom System Prompt (Optional)</label>
                    <textarea id="systemPromptInput" class="form-input h-40 resize-none" placeholder="You are a helpful assistant..."></textarea>
                </div>
                <div class="pt-4 flex gap-3">
                    <button id="saveSystemBtn" class="btn-primary flex-1">Save</button>
                    <button id="cancelSystemBtn" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="modal-content w-full max-w-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">Rename Chat</h2>
                <button id="closeRenameBtn" class="icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <input type="text" id="renameInput" class="form-input" placeholder="Chat name">
                <div class="pt-4 flex gap-3">
                    <button id="saveRenameBtn" class="btn-primary flex-1">Save</button>
                    <button id="cancelRenameBtn" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ============================================
        // CONFIGURATION - API KEY & MODEL YAHAN DALEIN
        // ============================================
        const HARDCODED_API_KEY = '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'; // <-- Apna API Key yahan paste karein
        const HARDCODED_MODEL = 'z-ai/glm-4.5-air:free';   // <-- Model name yahan change karein
        // ============================================

        // ============ State Management ============
        const STORAGE_KEYS = {
            CHATS: 'nexus_chats',
            CURRENT_CHAT: 'nexus_current_chat',
            THEME: 'nexus_theme',
            SYSTEM_PROMPT: 'nexus_system_prompt'
        };

        let state = {
            apiKey: HARDCODED_API_KEY,
            model: HARDCODED_MODEL,
            chats: [],
            currentChatId: null,
            theme: 'light',
            systemPrompt: '',
            isStreaming: false
        };

        // ============ DOM Elements ============
        let elements = {};

        function initElements() {
            elements = {
                loading: document.getElementById('loading'),
                app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebarOverlay'),
                menuBtn: document.getElementById('menuBtn'),
                newChatBtn: document.getElementById('newChatBtn'),
                chatList: document.getElementById('chatList'),
                chatTitle: document.getElementById('chatTitle'),
                messagesContainer: document.getElementById('messagesContainer'),
                messages: document.getElementById('messages'),
                emptyState: document.getElementById('emptyState'),
                messageInput: document.getElementById('messageInput'),
                sendBtn: document.getElementById('sendBtn'),
                toggleThemeBtn: document.getElementById('toggleThemeBtn'),
                themeIcon: document.getElementById('themeIcon'),
                themeText: document.getElementById('themeText'),
                editSystemBtn: document.getElementById('editSystemBtn'),
                systemModal: document.getElementById('systemModal'),
                closeSystemBtn: document.getElementById('closeSystemBtn'),
                systemPromptInput: document.getElementById('systemPromptInput'),
                saveSystemBtn: document.getElementById('saveSystemBtn'),
                cancelSystemBtn: document.getElementById('cancelSystemBtn'),
                renameModal: document.getElementById('renameModal'),
                closeRenameBtn: document.getElementById('closeRenameBtn'),
                renameInput: document.getElementById('renameInput'),
                saveRenameBtn: document.getElementById('saveRenameBtn'),
                cancelRenameBtn: document.getElementById('cancelRenameBtn')
            };
        }

        // ============ Storage Helpers ============
        function loadFromStorage() {
            try {
                // API Key & Model ab storage se nahi, hard-coded se aayenge
                state.apiKey = HARDCODED_API_KEY;
                state.model = HARDCODED_MODEL;
                
                state.theme = localStorage.getItem(STORAGE_KEYS.THEME) || 'light';
                state.systemPrompt = localStorage.getItem(STORAGE_KEYS.SYSTEM_PROMPT) || '';
                state.currentChatId = localStorage.getItem(STORAGE_KEYS.CURRENT_CHAT) || null;
                
                const chatsData = localStorage.getItem(STORAGE_KEYS.CHATS);
                state.chats = chatsData ? JSON.parse(chatsData) : [];
            } catch (e) {
                console.error('Failed to load from storage:', e);
            }
        }

        function saveToStorage() {
            try {
                // API Key & Model save nahi karenge
                localStorage.setItem(STORAGE_KEYS.THEME, state.theme);
                localStorage.setItem(STORAGE_KEYS.SYSTEM_PROMPT, state.systemPrompt);
                localStorage.setItem(STORAGE_KEYS.CHATS, JSON.stringify(state.chats));
                if (state.currentChatId) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_CHAT, state.currentChatId);
                }
            } catch (e) {
                console.error('Failed to save to storage:', e);
            }
        }

        // ============ Theme Management ============
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            if (state.theme === 'dark') {
                elements.themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                elements.themeText.textContent = 'Light Mode';
            } else {
                elements.themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                elements.themeText.textContent = 'Dark Mode';
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveToStorage();
        }

        // ============ Sidebar Management ============
        function openSidebar() {
            elements.sidebar.classList.remove('closed');
            elements.sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            elements.sidebar.classList.add('closed');
            elements.sidebarOverlay.classList.remove('active');
        }

        // ============ Chat Management ============
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function createChat() {
            const chat = {
                id: generateId(),
                title: 'New Chat',
                messages: [],
                systemPrompt: state.systemPrompt,
                createdAt: Date.now()
            };
            state.chats.unshift(chat);
            state.currentChatId = chat.id;
            saveToStorage();
            renderChatList();
            loadChat(chat.id);
            closeSidebar();
        }

        function getCurrentChat() {
            if (!state.currentChatId) return null;
            return state.chats.find(c => c.id === state.currentChatId) || null;
        }

        function loadChat(chatId) {
            state.currentChatId = chatId;
            const chat = getCurrentChat();
            if (!chat) return;

            elements.chatTitle.textContent = chat.title;
            renderMessages();
            saveToStorage();

            if (window.innerWidth < 768) {
                closeSidebar();
            }
        }

        function deleteChat(chatId, event) {
            if (event) event.stopPropagation();
            
            state.chats = state.chats.filter(c => c.id !== chatId);
            
            if (state.currentChatId === chatId) {
                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
            }
            
            saveToStorage();
            renderChatList();
            
            if (state.currentChatId) {
                loadChat(state.currentChatId);
            } else {
                elements.chatTitle.textContent = 'New Chat';
                elements.messages.innerHTML = '';
                elements.emptyState.style.display = 'flex';
            }
        }

        let renamingChatId = null;

        function showRenameModal(chatId, event) {
            if (event) event.stopPropagation();
            
            renamingChatId = chatId;
            const chat = state.chats.find(c => c.id === chatId);
            if (!chat) return;
            
            elements.renameInput.value = chat.title;
            elements.renameModal.style.display = 'flex';
            elements.renameInput.focus();
        }

        function saveRename() {
            if (!renamingChatId) return;
            
            const chat = state.chats.find(c => c.id === renamingChatId);
            if (!chat) return;
            
            const newTitle = elements.renameInput.value.trim() || 'New Chat';
            chat.title = newTitle;
            
            if (state.currentChatId === renamingChatId) {
                elements.chatTitle.textContent = newTitle;
            }
            
            saveToStorage();
            renderChatList();
            closeRenameModal();
        }

        function closeRenameModal() {
            elements.renameModal.style.display = 'none';
            renamingChatId = null;
        }

        function renderChatList() {
            elements.chatList.innerHTML = '';
            
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `chat-item flex items-center gap-2 p-3 cursor-pointer group ${isActive ? 'active' : ''}`;
                div.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-[var(--fg-muted)]">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="flex-1 truncate text-sm">${escapeHtml(chat.title)}</span>
                    <div class="hidden group-hover:flex items-center gap-1">
                        <button class="rename-btn icon-btn p-1" title="Rename">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                        </button>
                        <button class="delete-btn icon-btn p-1" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                div.addEventListener('click', () => loadChat(chat.id));
                div.querySelector('.rename-btn').addEventListener('click', (e) => showRenameModal(chat.id, e));
                div.querySelector('.delete-btn').addEventListener('click', (e) => deleteChat(chat.id, e));
                
                elements.chatList.appendChild(div);
            });
        }

        // ============ Message Rendering ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMessages() {
            const chat = getCurrentChat();
            if (!chat || chat.messages.length === 0) {
                elements.messages.innerHTML = '';
                elements.emptyState.style.display = 'flex';
                return;
            }
            
            elements.emptyState.style.display = 'none';
            elements.messages.innerHTML = '';
            
            chat.messages.forEach(msg => {
                appendMessage(msg.role, msg.content, false);
            });
            
            scrollToBottom();
        }

        function appendMessage(role, content, scroll = true) {
            elements.emptyState.style.display = 'none';
            
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = role === 'user' ? 'bg-[var(--user-bubble)]' : 'bg-[var(--ai-bubble)]';
            
            div.innerHTML = `
                <div class="message-bubble ${bubbleClass} px-4 py-3 rounded-2xl ${role === 'user' ? 'rounded-br-md' : 'rounded-bl-md'}">
                    <div class="message-content text-sm leading-relaxed">${role === 'user' ? escapeHtml(content) : renderMarkdown(content)}</div>
                </div>
            `;
            
            elements.messages.appendChild(div);
            
            if (scroll) {
                scrollToBottom();
            }
            
            return div;
        }

        function renderMarkdown(text) {
            try {
                return marked.parse(text);
            } catch (e) {
                return escapeHtml(text);
            }
        }

        function scrollToBottom() {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // ============ API Communication ============
        async function sendMessage() {
            const content = elements.messageInput.value.trim();
            if (!content || state.isStreaming) return;
            
            if (!state.apiKey) {
                alert('API Key configured nahi hai. Code me API Key daalen.');
                return;
            }
            
            let chat = getCurrentChat();
            if (!chat) {
                createChat();
                chat = getCurrentChat();
            }
            
            // Update chat title from first message
            if (chat.messages.length === 0) {
                chat.title = content.slice(0, 40) + (content.length > 40 ? '...' : '');
                elements.chatTitle.textContent = chat.title;
                renderChatList();
            }
            
            // Add user message
            chat.messages.push({ role: 'user', content });
            saveToStorage();
            
            appendMessage('user', content);
            elements.messageInput.value = '';
            elements.messageInput.style.height = 'auto';
            elements.sendBtn.disabled = true;
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `
                <div class="message-bubble bg-[var(--ai-bubble)] px-4 py-3 rounded-2xl rounded-bl-md">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            elements.messages.appendChild(typingDiv);
            scrollToBottom();
            
            state.isStreaming = true;
            
            try {
                const messages = [];
                
                // Add system prompt if exists
                const systemPrompt = chat.systemPrompt || state.systemPrompt;
                if (systemPrompt) {
                    messages.push({ role: 'system', content: systemPrompt });
                }
                
                // Add conversation history
                chat.messages.forEach(msg => {
                    messages.push({ role: msg.role, content: msg.content });
                });
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Nexus AI Chat'
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: messages,
                        stream: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI message bubble
                const aiDiv = appendMessage('assistant', '', false);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiContent = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const json = JSON.parse(data);
                                const delta = json.choices?.[0]?.delta?.content;
                                if (delta) {
                                    aiContent += delta;
                                    const contentEl = aiDiv.querySelector('.message-content');
                                    if (contentEl) {
                                        contentEl.innerHTML = renderMarkdown(aiContent);
                                    }
                                    scrollToBottom();
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }
                
                // Save AI response
                chat.messages.push({ role: 'assistant', content: aiContent });
                saveToStorage();
                
            } catch (error) {
                console.error('API Error:', error);
                typingDiv.remove();
                
                const errorDiv = appendMessage('assistant', `**Error:** ${error.message}`, false);
                const contentEl = errorDiv.querySelector('.message-content');
                if (contentEl) {
                    contentEl.style.color = 'var(--accent)';
                }
            } finally {
                state.isStreaming = false;
                updateSendButton();
            }
        }

        // ============ Modal Management ============
        function showSystemModal() {
            const chat = getCurrentChat();
            elements.systemPromptInput.value = chat?.systemPrompt || state.systemPrompt;
            elements.systemModal.style.display = 'flex';
            elements.systemPromptInput.focus();
        }

        function closeSystemModal() {
            elements.systemModal.style.display = 'none';
        }

        function saveSystemPrompt() {
            const prompt = elements.systemPromptInput.value.trim();
            const chat = getCurrentChat();
            
            if (chat) {
                chat.systemPrompt = prompt;
            } else {
                state.systemPrompt = prompt;
            }
            
            saveToStorage();
            closeSystemModal();
        }

        // ============ Input Handling ============
        function updateSendButton() {
            const hasContent = elements.messageInput.value.trim().length > 0;
            elements.sendBtn.disabled = !hasContent || state.isStreaming;
        }

        function autoResizeInput() {
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 200) + 'px';
        }

        // ============ Event Listeners ============
        function setupEventListeners() {
            // Sidebar
            elements.menuBtn.addEventListener('click', openSidebar);
            elements.sidebarOverlay.addEventListener('click', closeSidebar);
            
            // New Chat
            elements.newChatBtn.addEventListener('click', createChat);
            
            // Theme
            elements.toggleThemeBtn.addEventListener('click', toggleTheme);
            
            // System Prompt Modal
            elements.editSystemBtn.addEventListener('click', showSystemModal);
            elements.closeSystemBtn.addEventListener('click', closeSystemModal);
            elements.cancelSystemBtn.addEventListener('click', closeSystemModal);
            elements.saveSystemBtn.addEventListener('click', saveSystemPrompt);
            
            // Rename Modal
            elements.closeRenameBtn.addEventListener('click', closeRenameModal);
            elements.cancelRenameBtn.addEventListener('click', closeRenameModal);
            elements.saveRenameBtn.addEventListener('click', saveRename);
            
            // Input
            elements.messageInput.addEventListener('input', () => {
                updateSendButton();
                autoResizeInput();
            });
            
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            elements.sendBtn.addEventListener('click', sendMessage);
            
            // Close modals on backdrop click
            [elements.systemModal, elements.renameModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeSystemModal();
                    closeRenameModal();
                }
            });
        }

        // ============ Initialization ============
        function init() {
            // Initialize DOM elements first
            initElements();
            
            // Load state from storage
            loadFromStorage();
            
            // Apply theme
            applyTheme();
            
            // Setup event listeners
            setupEventListeners();
            
            // Render chat list
            renderChatList();
            
            // Load current chat if exists
            if (state.currentChatId) {
                loadChat(state.currentChatId);
            }
            
            // Show app, hide loader
            elements.loading.classList.add('hidden');
            setTimeout(() => {
                elements.loading.style.display = 'none';
            }, 300);
            elements.app.style.display = 'flex';
            elements.app.style.minHeight = '100vh';
            elements.app.style.minHeight = '100dvh';
        }

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
